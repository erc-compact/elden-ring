apptainer {
        enabled = true
        runOptions = '-B /hercules/scratch/fkareem --nv'
        envWhitelist = 'APPTAINER_BINDPATH, APPTAINER_LD_LIBRARY_PATH'
    }

report.overwrite = 'true'
trace.overwrite = 'true'

process {
    executor = 'slurm'

        withLabel: 'filtool' {
        cpus = 48
        memory = '300 GB'
        time = {4.hour * task.attempt}
        queue = { (task.time <= 4.hour) ? "short.q" : "long.q" }
        errorStrategy = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries = 2
    }

        withLabel: 'parse_xml' {
        cpus = 1
        memory = '5 GB'
        time = '15m'
        queue = 'short.q'
    }

        withLabel: 'peasoup' {
        cpus = 1
        memory = '50 GB'
        time = { 4.hour * task.attempt }
        queue = { (task.time <= 4.hour) ? "short.q" : "gpu.q" }
        clusterOptions = '--gres=gpu:1'
        errorStrategy = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries = 2
    }

        withLabel: 'psrfold' {
        cpus = 48
        memory = '360 GB'
        time = {4.hour * task.attempt}
        queue = { (task.time <= 4.hour) ? "short.q" : "long.q" }
        errorStrategy = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries = 2
    }

        withLabel: 'pics_classifier' {
        cpus = 48
        memory = '360 GB'
        time = 4.hour
        queue = 'short.q'
    }

        withLabel: 'splitcands' {
        cpus = 1
        memory = '5 GB'
        time = '15m'
        queue = 'short.q'
    }

        withLabel: 'candcsv_parse' {
        cpus = 1
        memory = '5 GB'
        time = '15m'
        queue = 'short.q'
    }

        withLabel: 'candypolice' {
        cpus = 48
        memory = '360 GB'
        queue = 'short.q'
        time = '4h'
    }
}

params{
    singularity_image_dir="/hercules/scratch/vishnu/singularity_images/"
    pulsarx_image = "${params.singularity_image_dir}/pulsarx_latest.sif"
    presto_image = "${params.singularity_image_dir}/pulsar-miner_turing-sm75.sif"
    peasoup_image = "${params.singularity_image_dir}/peasoup_latest.sif"
    psrchive_image = "${params.singularity_image_dir}/trapum_pulsarx_fold_docker_20220411.sif"
    threads = 48
}