/*
 * PRESTO Pipeline Test Configuration
 *
 * Test file: /hercules/results/rsenzel/signal_inject/J0514-4002A_3HM_000_52.0_01_noise_t4_15min_inj_FAZAL_PRESTO.fil
 * Injected pulsar at DM = 30
 */

params {
    cache           = 'lenient'

    // Base directories
    basedir         = "/hercules/results/fkareem/ELDEN/elden-ring/test_presto/output"
    runID           = "PRESTO_TEST_001"
    target_name     = "J0514-4002A_test"
    output_dir      = "${basedir}"
    template_dir    = "${projectDir}/templates"
    pics_model_dir  = "${projectDir}/ML_Models"
    split_fil       = false
    split_freq      = 0.0
    stack_by_cdm    = false
    stacks          = [:]

    // Search backend selection: 'peasoup' (default) or 'presto'
    search_backend  = 'presto'

    // Input files
    files_list      = "${projectDir}/test_presto/test_presto_inputfile.csv"
    metafile_source_path = "${basedir}/meta/"

    // Tarball naming prefix
    tarball_prefix  = "presto_test"

    // Telescope configuration (adjust based on the filterbank source)
    telescope       = "meerkat"

    // Copy files from tape?
    copy_from_tape {
        run_copy   = false
        remoteUser = ""
        remoteHost = ""
        archivePath = ""
    }

    dada {
        dada_csv = ""
        bits = 8
        nsblk = 4096
        nchan = 64
        tsamp = 6.02353e-05
        dedispersion = true
        nfft = 32768
        npol = 1
    }

    // Generate RFI Filter Parameters
    generateRfiFilter {
        default_flag = "kadaneF 8 4 kadaneT 8 4"
        run_rfi_filter       = false
        target_resolution_ms = 1.0
    }

    // only for rfi-filter-test
    rfi_filter_test {
        rfi_filter_file = ""
        known_csv = ""
    }

    // Filtool Parameters
    filtool {
        run_filtool = false
        output_path = "${basedir}/Filtool"
        td = 1
        fd = 1
        flip = false
        rfi_filter_list = [
            effelsberg: "kadaneF 8 4 kadaneT 8 4",
            meerkat: "kadaneF 8 4 kadaneT 8 4"
        ]
        run_filtool_cleanup = false
    }

    // Dispersion Measure (DM) Plan
    ddplan {
        use_zero_dm = true
        dm_start  = 29
        dm_end    = 31
        dm_step   = 0.2
        dm_sample = 100
    }

    // Peasoup Parameters
    peasoup {
        segmented_search    = true
        segments            = [1]
        birdies_min_snr     = 11.0
        default_birdies     = "${projectDir}/include/default_birdies.txt"
        birdies_max_freq    = 8300.0
        birdies_ram_limit_gb = 90.0
        birdies_harmonics  = 1
        min_snr             = 7.0
        acc_start           = -1
        acc_end             = 1
        ram_limit_gb        = 145
        nharmonics          = 4
        ngpus               = 1
        total_cands_limit   = 5000
        dump_timeseries     = false
    }

    // Parse XML Parameters
    parse_xml {
        script              = "${projectDir}/scripts/parse_split.py"
        pick_candies        = true
        candy_picker_period_threshold = 1e-7
        candy_picker_remove_birdies = true
        candy_picker_birdies_file = "${projectDir}/include/default_birdies.txt"
        birdies_harmonics = 16
        scale_birdie_width = true
        candy_picker_dm_tolerance = 0
        filter_cands      = true
        config_file       = "${projectDir}/templates/pulsarx_fold_config_eff.json"
    }

    // PsrFold Parameters
    psrfold {
        output_path = "${basedir}/PulsarX/Fold"
        fold_technique      = "pulsarx"
        nbins               = 32
        binplan             = "0.005 32 0.01 64 0.1 128"
        subintlength        = 'None'
        nsub                = 64
        clfd               = 2.0
        threads            = 8
        template_dir       = "${projectDir}/templates"
        cands_per_node     = 350
        cluster_folded     = false
        dm_tolerance       = 0
    }

    alpha_beta_gamma {
        snr_min = 7.0
        create_candyjar_tarball = false
        output_dir_alpha_pics_results = "PRESTO_TEST"
        threshold = 0.1
        snr_threshold = 6.0
    }

    parfold {
        output_path = "${basedir}/PulsarX/ParFold"
        parfile_path = ""
        threads = 8
        subintlength = 10
        nbins = 32
        binplan = "0.005 32 0.01 64 0.1 128"
        nsub = null
        clfd = 2.0
    }

    candypolice {
        input_csv = ""
        output_dir = ""
        pulsarx_threads = 8
        nsub = 64
        nbins = 32
        binplan = "0.005 32 0.01 64 0.1 128"
        clfd = 2.0
    }

    // =========================================================================
    // PRESTO Pipeline Parameters (used when search_backend = 'presto')
    // =========================================================================
    presto {
        // Stage control (1-6, or run all by default)
        start_stage     = 1
        end_stage       = 6

        // RFI detection parameters (Stage 1)
        rfifind_time        = 2.0
        rfifind_chanfrac    = 0.5
        rfifind_intfrac     = 0.3
        rfifind_timesig     = 10
        rfifind_freqsig     = 4

        // Birdie detection parameters (Stage 2)
        birdie_zmax         = 0

        // Dedispersion parameters (Stage 3)
        nsub                = 64

        // DM ranges - centered around DM=30 with buffer
        dm_ranges = [
            [dm_low: 20.0, dm_high: 40.0, dm_step: 0.5, downsamp: 1]
        ]

        // Acceleration search parameters (Stage 4)
        numharm             = 8
        zmax                = 200
        wmax                = 0
        sigma_threshold     = 2.0
        use_gpu             = true
        accelsearch_cuda_bin = "accelsearch_cu"
        segment_chunks      = 1

        // Candidate sifting parameters (Stage 5)
        sift_short_period   = 0.0005
        sift_long_period    = 15.0
        sift_sigma_threshold = 5.0
        sift_max_cands      = 500
        sift_min_num_dms    = 1
        sift_low_dm_cutoff  = 2.0

        // Folding parameters (Stage 5)
        fold_backend        = 'presto'
        fold_nsub           = 64
        fold_npart          = 64
        max_fold_cands      = 100
        fft_size            = 134217728

        // Post-processing parameters (Stage 6)
        pics_threshold      = 0.1
        snr_threshold       = 4.0
    }

    // Notification settings
    notification {
        enabled = false
    }
}
