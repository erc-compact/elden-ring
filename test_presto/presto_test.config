/*
 * PRESTO Pipeline Test Configuration
 *
 * Test file: /hercules/results/rsenzel/signal_inject/J0514-4002A_3HM_000_52.0_01_noise_t4_15min_inj_FAZAL_PRESTO.fil
 * Injected pulsar at DM = 30
 */

params {
    cache           = 'lenient'

    // Base directories
    basedir         = "/hercules/results/fkareem/ELDEN/elden-ring/test_presto/output"
    runID           = "PRESTO_TEST_001"
    target_name     = "J0514-4002A_test"
    output_dir      = "${basedir}"
    template_dir    = "${projectDir}/templates"
    pics_model_dir  = "${projectDir}/ML_Models"

    // Search backend - use PRESTO
    search_backend  = 'presto'

    // Input files
    files_list      = "${projectDir}/test_presto/test_presto_inputfile.csv"
    metafile_source_path = "${basedir}/meta/"

    // Tarball naming prefix
    tarball_prefix  = "presto_test"

    // Telescope configuration (adjust based on the filterbank source)
    telescope       = "meerkat"

    // Disable preprocessing - assume filterbank is already cleaned
    generateRfiFilter {
        run_rfi_filter = false
    }

    filtool {
        run_filtool = false
    }

    // PRESTO Pipeline Parameters - tuned for DM=30 injected pulsar
    presto {
        // Stage control (1-6, or run all by default)
        start_stage     = 1
        end_stage       = 6

        // RFI detection parameters (Stage 1)
        rfifind_time        = 2.0      // Seconds per integration
        rfifind_chanfrac    = 0.5      // Fraction of channels to flag as bad
        rfifind_intfrac     = 0.3      // Fraction of intervals to flag as bad
        rfifind_timesig     = 10       // Time domain sigma threshold
        rfifind_freqsig     = 4        // Frequency domain sigma threshold

        // Birdie detection parameters (Stage 2)
        birdie_zmax         = 0        // Zero acceleration for birdie search

        // Dedispersion parameters (Stage 3)
        nsub                = 128      // Number of subbands

        // DM ranges - centered around DM=30 with buffer
        dm_ranges = [
            [dm_low: 20.0, dm_high: 40.0, dm_step: 0.5, downsamp: 1]
        ]

        // Acceleration search parameters (Stage 4)
        numharm             = 8        // Number of harmonics to sum
        zmax                = 200      // Max acceleration (z)
        wmax                = 0        // Max jerk (w) - disabled for speed
        sigma_threshold     = 2.0      // Sigma threshold for candidates
        use_gpu             = true     // Use GPU acceleration if available
        accelsearch_cuda_bin = "accelsearch_cu" // CUDA binary name when use_gpu=true
        segment_chunks      = 1        // >1 to split timeseries into chunks before accelsearch

        // Candidate sifting parameters (Stage 5)
        sift_short_period   = 0.0005   // 0.5ms minimum period
        sift_long_period    = 15.0     // 15s maximum period
        sift_sigma_threshold = 5.0     // Sigma threshold for sifted candidates
        sift_max_cands      = 500      // Max candidates to keep
        sift_min_num_dms    = 1        // Minimum DMs for detection (DM problem filter)
        sift_low_dm_cutoff  = 2.0      // Lowest DM considered as real pulsar

        // Folding parameters (Stage 5)
        fold_backend        = 'presto' // Use prepfold (not pulsarx)
        fold_nsub           = 128      // Number of subbands for folding
        fold_npart          = 64       // Number of sub-integrations
        max_fold_cands      = 100      // Maximum candidates to fold
        fft_size            = 134217728  // FFT size for period correction

        // Post-processing parameters (Stage 6)
        pics_threshold      = 0.1      // PICS score threshold
        snr_threshold       = 6.0      // SNR threshold for output
    }

    // Notification settings
    notification {
        enabled = false
    }
}
