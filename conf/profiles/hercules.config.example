// Define container image paths specific to Hercules cluster
params {
    // Container images for Hercules
    singularity_image_dir = "/hercules/scratch/fkareem/singularity_img"
    pulsarx_image         = "${singularity_image_dir}/pulsarx_latest.sif"
    presto_image          = "${singularity_image_dir}/presto4.sif"
    peasoup_image         = "${singularity_image_dir}/peasoup_keplerian.sif"
    psrchive_image        = "${singularity_image_dir}/trapum_pulsarx_fold_docker_20220411.sif"
    rfi_mitigation_image  = "/hercules/scratch/fkareem/singularity_img/rfi-mitigation-nextflow_amd64.sif"
    presto5_image         = "${singularity_image_dir}/presto5_pddot.sif"
    pics_classifier_image = "/hercules/scratch/fkareem/singularity_img/trapum_pulsarx_fold_docker_20220411.sif"
    filtools_sig_image    = "${singularity_image_dir}/filtools-image_sig.sif"
    rusty_candypicker     = "${singularity_image_dir}/rusty_candypicker_latest.sif"
    // PrestoZL GPU-accelerated container (pull from zjlabastro/prestozl:v1.0)
    prestozl_image        = "/hercules/scratch/vishnu/singularity_images/prestozl_v1.0.sif"
    // Riptide FFA search container (PLACEHOLDER - update with actual path)
    riptide_image         = "${singularity_image_dir}/riptide_latest.sif"
    // Number of threads for processes used in filtool
    threads = 48  // Adjust as per the cluster's CPU availability
}


process {
    executor = 'slurm'
    cache = 'lenient'

    // Filtool Process Configuration
    withLabel: 'filtool' {
        cpus           = 48  // Use the maximum available CPUs
        memory         = '360 GB'
        time           = { 4.hour * task.attempt }
        queue          = { (task.time <= 4.hour) ? 'short.q' : 'long.q' }
        errorStrategy  = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries     = 2
    }

    // Parse XML Process Configuration
    withLabel: 'parse_xml' {
        cpus       = 1
        memory     = '5 GB'
        time       = '15m'
        queue      = 'short.q'
    }

    // Birdies Process Configuration
    withLabel: 'birdies' {
        cpus           = 1
        memory         = '100 GB'
        time           = { 4.hour * task.attempt }
        queue          = { (task.time <= 4.hour) ? "short.q" : "gpu.q" }
        clusterOptions = '--gres=gpu:1'
        errorStrategy  = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries     = 2
    }

    // Peasoup Process Configuration
    withLabel: 'peasoup' {
        cpus           = 1
        memory         = '200 GB'
        time           = { 4.hour * task.attempt }
        queue          = { (task.time <= 4.hour) ? "short.q" : "gpu.q" }
        clusterOptions = '--gres=gpu:1'
        errorStrategy  = { task.exitStatus in (137..140) ? (task.attempt < 1 ? 'retry' : 'ignore') : task.exitStatus == 1 ? 'ignore' : 'finish' }
        maxRetries     = 1
    }

    // PsrFold Process Configuration
    withLabel: 'psrfold' {
        cpus           = 48
        memory         = '360 GB'
        time           = { 4.hour * task.attempt }
        queue          = { (task.time <= 4.hour) ? 'short.q' : 'long.q' }
        errorStrategy  = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries     = 2
    }

    // Pics Classifier Process Configuration
    withLabel: 'pics_classifier' {
        cpus       = 48
        memory     = '360 GB'
        time       = '4h'
        queue      = 'short.q'
    }

    // Splitcands Process Configuration
    withLabel: 'splitcands' {
        cpus       = 1
        memory     = '5 GB'
        time       = '15m'
        queue      = 'short.q'
    }

    withLabel: 'search_fold_merge' {
        cpus       = 1
        memory     = '5 GB'
        time       = '15m'
        queue      = 'short.q'
    }

    // Readfile Process Configuration
    withLabel: 'readfile' {
        cpus           = 1
        memory         = '10 GB'
        time           = '15m'
        queue          = 'short.q'
        errorStrategy  = 'retry'
        maxRetries     = 1
    }

    // Generate RFI Filter Process Configuration
    withLabel: 'generate_rfi_filter' {
        cpus           = 48
        memory         = '360 GB'
        time           = '4h'
        queue          = 'short.q'
        errorStrategy  = 'retry'
        maxRetries     = 2
    }

    // Nearest Power of Two Calculator Process Configuration
    withLabel: 'nearest_power_two_calculator' {
        cpus       = 1
        memory     = '10 GB'
        time       = '15m'
        queue      = 'short.q'
    }

    // Generate DM Files Process Configuration
    withLabel: 'generateDMFiles' {
        cpus       = 1
        memory     = '5 GB'
        time       = '10m'
        queue      = 'short.q'
    }

    // =========================================================================
    // PRESTO Pipeline Process Configurations
    // =========================================================================

    // PRESTO CPU processes (rfifind, prepdata, prepsubband, prepfold, sifting)
    withLabel: 'presto' {
        cpus           = 8
        memory         = '64 GB'
        time           = { 4.hour * task.attempt }
        queue          = { (task.time <= 4.hour) ? 'short.q' : 'long.q' }
        errorStrategy  = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries     = 2
        container      = "${params.prestozl_image}"
    }

    // PRESTO GPU processes (accelsearch with CUDA)
    withLabel: 'presto_gpu' {
        cpus           = 4
        memory         = '128 GB'
        time           = { 4.hour * task.attempt }
        queue          = 'gpu.q'
        clusterOptions = '--gres=gpu:1'
        errorStrategy  = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries     = 2
        container      = "${params.prestozl_image}"
    }

    // Short PRESTO processes (sifting, PNG conversion, tarball)
    withLabel: 'short' {
        time   = '1h'
        queue  = 'short.q'
    }

    // Medium PRESTO processes (single candidate folding)
    withLabel: 'medium' {
        time   = '2h'
        queue  = 'short.q'
    }

    // Long PRESTO processes (batch folding, dedispersion)
    withLabel: 'long' {
        time   = { 4.hour * task.attempt }
        queue  = { (task.time <= 4.hour) ? 'short.q' : 'long.q' }
    }

    // PulsarX folding for PRESTO candidates
    withLabel: 'pulsarx' {
        cpus           = 16
        memory         = '64 GB'
        time           = { 4.hour * task.attempt }
        queue          = { (task.time <= 4.hour) ? 'short.q' : 'long.q' }
        errorStrategy  = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries     = 2
        container      = "${params.pulsarx_image}"
    }

    // =========================================================================
    // Riptide FFA Pipeline Process Configuration
    // =========================================================================

    // Riptide FFA search processes
    withLabel: 'riptide' {
        cpus           = 4
        memory         = '64 GB'
        time           = { 4.hour * task.attempt }
        queue          = { (task.time <= 4.hour) ? 'short.q' : 'long.q' }
        errorStrategy  = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries     = 2
        container      = "${params.riptide_image}"
    }

    // alpha_beta_gamma_test Process Configuration
    withLabel: 'alpha_beta_gamma_test' {
        cpus       = 4
        memory     = '20 GB'
        time       = '1h'
        queue      = 'short.q'
    }

    // split_filterbank Process Configuration
    withLabel: 'split_filterbank' {
        cpus       = 1
        memory     = '20 GB'
        time       = '1h'
        queue      = 'short.q'
    }

    // merge_filterbanks Process Configuration
    withLabel: 'merge_filterbanks' {
        cpus           = 4
        memory         = '50 GB'
        time           = { 2.hour * task.attempt }
        queue          = 'short.q'
        errorStrategy  = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries     = 2
    }

    // segmented_params Process Configuration
    withLabel: 'segmented_params' {
        cpus       = 1
        memory     = '10 GB'
        time       = '15m'
        queue      = 'short.q'
    }

    // candypolice_pulsarx Process Configuration
    withLabel: 'candypolice_pulsarx' {
        cpus           = 48
        memory         = '200 GB'
        time           = { 4.hour * task.attempt }
        queue          = { (task.time <= 4.hour) ? 'short.q' : 'long.q' }
        errorStrategy  = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries     = 2
    }

    // candypolice_presto Process Configuration
    withLabel: 'candypolice_presto' {
        cpus           = 8
        memory         = '64 GB'
        time           = { 4.hour * task.attempt }
        queue          = { (task.time <= 4.hour) ? 'short.q' : 'long.q' }
        errorStrategy  = { task.exitStatus in (137..140) ? 'retry' : 'finish' }
        maxRetries     = 2
    }
}

// Apptainer/Singularity configuration for Hercules
apptainer {
    enabled = true
    autoMounts   = true
    runOptions = '-B /hercules/ -B /u/ --nv'
    envWhitelist = 'APPTAINER_BINDPATH, APPTAINER_LD_LIBRARY_PATH'
}

// Report and trace settings
report {
    overwrite = true
}

trace {
    overwrite = true
}
