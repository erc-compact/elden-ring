/*
 * =============================================================================
 * ELDEN-RING Pipeline Configuration
 * =============================================================================
 *
 * This configuration file controls all pipeline parameters.
 * Edit the sections below to customize your pulsar search.
 *
 * Quick Start:
 *   1. Set basedir, runID, and target_name in "Essential Settings"
 *   2. Set your telescope
 *   3. Configure DM range in ddplan section
 *   4. Choose search_backend: 'peasoup' (GPU) or 'presto' (CPU)
 *   5. Run: nextflow run elden.nf -entry full -c params.config -profile hercules
 *
 * =============================================================================
 */

params {

    // =========================================================================
    //  ESSENTIAL SETTINGS - You must configure these
    // =========================================================================

    basedir         = "/path/to/your/project"       // Output directory
    runID           = "my_search_v1"                // Unique run identifier
    target_name     = "NGC6544"                     // Target/cluster name
    telescope       = "effelsberg"                  // Options: effelsberg, meerkat

    // =========================================================================
    //  INPUT FILES
    // =========================================================================

    files_list          = "${basedir}/inputfile.txt"    // CSV with observation details
    metafile_source_path = "${basedir}/meta/"           // Metafile directory (optional)

    // =========================================================================
    //  SEARCH BACKEND SELECTION
    // =========================================================================
    //
    //  'peasoup' - GPU-accelerated FFT search (faster, requires NVIDIA GPU)
    //  'presto'  - CPU-based acceleration search (more flexible, no GPU needed)
    //
    search_backend  = "peasoup"

    // =========================================================================
    //  DISPERSION MEASURE (DM) SEARCH RANGE
    // =========================================================================

    ddplan {
        dm_start    = -10       // Start DM (relative to coherent DM if use_zero_dm=true)
        dm_end      = 10        // End DM
        dm_step     = 0.1       // DM step size
        dm_sample   = 100       // Samples per DM trial
        use_zero_dm = true      // If true, DM range is relative to coherent DM
    }

    // =========================================================================
    //  DATA PREPROCESSING
    // =========================================================================

    // RFI Detection and Filtering
    generateRfiFilter {
        run_rfi_filter          = true              // Generate RFI diagnostic plots
        default_flag            = "kadaneF 8 4 kadaneT 8 4"
        target_resolution_ms    = 1.0               // Time resolution for RFI stats
    }

    // Filterbank Cleaning (filtool)
    filtool {
        run_filtool     = true
        td              = 1                         // Time decimation factor
        fd              = 1                         // Frequency decimation factor
        flip            = true                      // Flip band if needed

        // Telescope-specific RFI filters
        rfi_filter_list = [
            effelsberg: "kadaneF 8 4 kadaneT 8 4 zdot zap 1432.65 1434.68 zap 1452.47 1472.29",
            meerkat:    "kadaneF 8 4 kadaneT 8 4 zdot"
        ]

        run_filtool_cleanup = false                 // Delete original files after cleaning
    }

    // Filterbank Splitting (for wide-band data)
    split_fil   = false
    split_freq  = 1200.0                            // Split frequency in MHz

    // Beam Stacking by Coherent DM
    stack_by_cdm = false
    stacks = [
        '0000123': [1, 2, 3],
        '0004567': [4, 5, 6, 7],
        '1234567': [1, 2, 3, 4, 5, 6, 7]
    ]

    // =========================================================================
    //  PEASOUP SEARCH SETTINGS (when search_backend = 'peasoup')
    // =========================================================================

    peasoup {
        // Search Configuration
        min_snr         = 7.0           // Minimum S/N threshold
        acc_start       = -50           // Acceleration range start (m/s^2)
        acc_end         = 50            // Acceleration range end (m/s^2)
        nharmonics      = 4             // Harmonics to sum
        ram_limit_gb    = 145           // GPU memory limit
        ngpus           = 1             // Number of GPUs

        // Segmented Search
        segmented_search = true
        segments        = [1]           // [1]=full, [1,2]=full+halves, [1,2,4]=full+halves+quarters

        // Birdie Detection
        birdies_min_snr     = 11.0
        birdies_max_freq    = 8300.0    // Max frequency for birdies (Hz)
        birdies_harmonics   = 1
        birdies_ram_limit_gb = 90.0
        default_birdies     = "${projectDir}/include/default_birdies.txt"

        // Candidate Limits
        total_cands_limit   = 5000

        // Time Series Dumping (for hybrid PRESTO/FFA processing)
        dump_timeseries = false         // Set true to enable PRESTO accelsearch on peasoup data
    }

    // =========================================================================
    //  PRESTO SEARCH SETTINGS (when search_backend = 'presto')
    // =========================================================================

    presto {
        // --- RFI Detection (rfifind) ---
        rfifind_time        = 2.0       // Integration time (seconds)
        rfifind_chanfrac    = 0.5       // Channel fraction threshold
        rfifind_intfrac     = 0.3       // Interval fraction threshold
        rfifind_timesig     = 10        // Time-domain sigma
        rfifind_freqsig     = 4         // Frequency-domain sigma

        // --- Dedispersion (prepsubband) ---
        nsub = 128                      // Number of subbands

        // DM ranges: each entry defines a range with different resolution
        dm_ranges = [
            [dm_low: 0.0,   dm_high: 30.0,  dm_step: 0.1,  downsamp: 1],
            [dm_low: 30.0,  dm_high: 100.0, dm_step: 0.3,  downsamp: 2],
            [dm_low: 100.0, dm_high: 300.0, dm_step: 1.0,  downsamp: 4],
            [dm_low: 300.0, dm_high: 500.0, dm_step: 2.0,  downsamp: 8]
        ]

        // --- Acceleration Search (accelsearch) ---
        zmax            = 200           // Max acceleration (z)
        wmax            = 0             // Max jerk (w), 0 = no jerk search
        numharm         = 8             // Harmonics to sum
        sigma_threshold = 2.0           // Detection sigma
        segment_chunks  = 1             // Split time series before search (1 = no split)

        // GPU Acceleration (requires CUDA-enabled PRESTO)
        use_gpu             = true
        accelsearch_cuda_bin = "accelsearch_cu"

        // --- Candidate Sifting ---
        sift_short_period       = 0.0005    // Shortest period (seconds)
        sift_long_period        = 15.0      // Longest period (seconds)
        sift_sigma_threshold    = 4.0       // Minimum sigma
        sift_max_cands          = 500       // Max candidates to keep
        sift_min_num_dms        = 1         // Min DM detections required
        sift_low_dm_cutoff      = 2.0       // Lowest DM considered real

        // --- Folding ---
        fold_backend    = "pulsarx"     // Options: 'presto' (prepfold) or 'pulsarx'
        max_fold_cands  = 100           // Max candidates to fold

        // prepfold settings (when fold_backend = 'presto')
        fold_npart      = 64            // Sub-integrations
        fold_nsub       = 128           // Subbands

        // PulsarX settings (when fold_backend = 'pulsarx')
        fold_nbins          = 64
        fold_subint_length  = 10.0
        fold_threads        = 16
        fold_clfd           = 2.0
        fold_binplan        = "0.005 32 0.01 64 0.1 128"
    }

    // =========================================================================
    //  RIPTIDE FFA SEARCH (Optional - for long-period pulsars)
    // =========================================================================
    //
    //  Fast Folding Algorithm search, complementary to FFT-based searches.
    //  Configure search parameters in riptide_config.yml (not here). This will be in your basedir, if you run setup_basedir. 
    //  Documentation: https://riptide-ffa.readthedocs.io/

    riptide {
        run_ffa_search  = false                         // Enable FFA search
        config_file     = "${basedir}/riptide_config.yml"
        backend         = "presto"                      // For standalone: 'presto' or 'peasoup'
    }

    // =========================================================================
    //  CANDIDATE PARSING (XML from peasoup)
    // =========================================================================

    parse_xml {
        pick_candies                = true
        filter_cands                = true
        config_file                 = "${projectDir}/templates/pulsarx_fold_config_eff.json"

        // Birdie Removal
        candy_picker_remove_birdies = true
        candy_picker_birdies_file   = "${projectDir}/include/default_birdies.txt"
        birdies_harmonics           = 16
        scale_birdie_width          = true

        // Candidate Selection
        candy_picker_period_threshold = 1e-7
        candy_picker_dm_tolerance   = 0
    }

    // =========================================================================
    //  CANDIDATE FOLDING (PulsarX)
    // =========================================================================

    psrfold {
        fold_technique  = "pulsarx"
        nbins           = 32
        binplan         = "0.005 32 0.01 64 0.1 128"
        subintlength    = "None"        // Auto-calculate if 'None'
        nsub            = 64
        clfd            = 2.0
        threads         = 48
        template_dir    = "${projectDir}/templates"

        cands_per_node  = 350           // Candidates per batch
        cluster_folded  = true          // Cluster similar candidates
        dm_tolerance    = 0
    }

    // =========================================================================
    //  CLASSIFICATION AND SCORING
    // =========================================================================

    alpha_beta_gamma {
        threshold                   = 0.1       // PICS score threshold
        snr_threshold               = 7.0
        create_candyjar_tarball     = true
        output_dir_alpha_pics_results = "${target_name}_${runID}"
    }

    // =========================================================================
    //  UTILITY WORKFLOWS
    // =========================================================================

    // Fold with known ephemeris (parfold workflow)
    parfold {
        parfile_path    = "/path/to/pulsar.par"
        threads         = 48
        subintlength    = 10
        nbins           = 32
        binplan         = "0.005 32 0.01 64 0.1 128"
        clfd            = 2.0
    }

    // Re-fold candidates from CandyJar (candypolice workflow)
    candypolice {
        input_csv       = "/path/to/candyjar.csv"
        output_dir      = "${basedir}/refold"
        pulsarx_threads = 20
        nsub            = 64
        nbins           = 32
        binplan         = "0.005 32 0.01 64 0.1 128"
        clfd            = 2.0
    }

    // =========================================================================
    //  ADVANCED: DADA Baseband Processing
    // =========================================================================

    dada {
        dada_csv        = "${basedir}/dada_files.csv"
        bits            = 8
        nsblk           = 4096
        nchan           = 768
        tsamp           = 60e-6
        dedispersion    = true
        nfft            = 32768
        npol            = 1
    }

    // =========================================================================
    //  ADVANCED: Remote Data Copy
    // =========================================================================

    copy_from_tape {
        run_copy    = false
        remoteUser  = "username"
        remoteHost  = "archive.example.com"
        archivePath = "/path/to/archive/data"
    }

    // =========================================================================
    //  NOTIFICATIONS (Optional)
    // =========================================================================

    notification {
        enabled     = false
        email       = ""                // Your email address
        on_complete = true
        on_fail     = true
        on_error    = true
    }

    // =========================================================================
    //  INTERNAL SETTINGS (usually don't need to change)
    // =========================================================================

    cache           = "lenient"
    template_dir    = "${projectDir}/templates"
    pics_model_dir  = "${projectDir}/ML_Models"
}
